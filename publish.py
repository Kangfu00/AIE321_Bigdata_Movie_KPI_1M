# publish.py

import pandas as pd
from sqlalchemy import create_engine
import os
from dotenv import load_dotenv

# ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏•‡∏ö‡∏£‡∏≤‡∏£‡∏µ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Google Sheets
import gspread
from gspread_dataframe import set_with_dataframe 

# --- 1. ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏Ñ‡∏á‡∏ó‡∏µ‡πà ---
PRODUCTION_TABLE_NAME = 'movie_facts' 
PRODUCTION_SCHEMA_NAME = 'production'
# GOOGLE_SHEET_TITLE = 'Kaggle Data Pipeline Report'  <--- (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß)
WORKSHEET_NAME = 'Final Data' 

# üö® ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢ File ID ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏°‡∏≤
GOOGLE_SHEET_ID = '1ZGoqwqq17L2_6ywhCK27-KsPyJ-V0xcgQfjIYblNmpw' 

# üö® ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Service Account (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ä‡πâ)
CREDENTIALS_FILE = 'client_secret.json' 

def run_publication_pipeline():
    # 1. ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏†‡∏≤‡∏û‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏°‡∏à‡∏≤‡∏Å .env
    load_dotenv()
    # ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å .env 
    DB_HOST = os.getenv("DB_HOST")
    DB_USER = os.getenv("POSTGRES_USER")
    DB_PASSWORD = os.getenv("POSTGRES_PASSWORD")
    DB_NAME = os.getenv("POSTGRES_DB")
    DB_PORT = os.getenv("DB_PORT")

    # --- 2. ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á) ---
    try:
        conn_string = f'postgresql://{DB_USER}:{DB_PASSWORD}@{DB_HOST}:{DB_PORT}/{DB_NAME}'
        engine = create_engine(conn_string)

        print(f"--- ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å {PRODUCTION_SCHEMA_NAME}.{PRODUCTION_TABLE_NAME} (Host: {DB_HOST}:{DB_PORT}) ---")
        
        sql_query = f"SELECT * FROM {PRODUCTION_SCHEMA_NAME}.{PRODUCTION_TABLE_NAME};"
        final_df = pd.read_sql(sql_query, con=engine)
        
        print(f"‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà‡∏°‡∏≤‡πÑ‡∏î‡πâ {len(final_df)} ‡πÅ‡∏ñ‡∏ß")

    except Exception as e:
        print(f"!!! Error: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ DB ‡∏´‡∏£‡∏∑‡∏≠‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ !!!")
        print(f"‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏: {e}")
        return 

    # --- 3. ‡∏Å‡∏≤‡∏£‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà‡πÑ‡∏õ‡∏¢‡∏±‡∏á Google Sheets (‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç) ---
    if final_df.empty:
        print("!!! ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á Production ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà‡πÑ‡∏î‡πâ !!!")
        return

    print(f"--- ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á Google Sheets: {GOOGLE_SHEET_ID} ---")
    
    try:
        # ‡πÉ‡∏ä‡πâ gspread.service_account() 
        gc = gspread.service_account(filename=CREDENTIALS_FILE)
        
        # üö® ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ gc.auth.service_account_email
        print(f"‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏î‡πâ‡∏ß‡∏¢ Service Account.") 
        
        # *** üö® ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÉ‡∏ä‡πâ gc.open_by_key() ‡πÅ‡∏ó‡∏ô gc.open() ***
        try:
            # ‡πÉ‡∏ä‡πâ File ID ‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡πâ‡∏≤‡∏°‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Naming Mismatch
            spreadsheet = gc.open_by_key(GOOGLE_SHEET_ID) 
            print(f"‡∏û‡∏ö Spreadsheet ‡∏î‡πâ‡∏ß‡∏¢ ID: {GOOGLE_SHEET_ID}")
        except gspread.SpreadsheetNotFound:
            # ‡∏´‡∏≤‡∏Å‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏î‡πâ‡∏ß‡∏¢ ID ‡πÉ‡∏´‡πâ‡πÅ‡∏à‡πâ‡∏á Error ‡∏ó‡∏µ‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
            print(f"!!! Error: ‡πÑ‡∏°‡πà‡∏û‡∏ö Spreadsheet ‡∏î‡πâ‡∏ß‡∏¢ ID ‡∏ô‡∏µ‡πâ ({GOOGLE_SHEET_ID})")
            print("‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö ID ‡πÅ‡∏•‡∏∞‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡πÑ‡∏î‡πâ‡πÅ‡∏ä‡∏£‡πå‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Editor ‡πÉ‡∏´‡πâ Service Account ‡πÅ‡∏•‡πâ‡∏ß")
            return
            
        # ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á Worksheet
        try:
            worksheet = spreadsheet.worksheet(WORKSHEET_NAME)
        except gspread.WorksheetNotFound:
            # ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏û‡∏ö Worksheet ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á Worksheet ‡πÉ‡∏´‡∏°‡πà‡∏†‡∏≤‡∏¢‡πÉ‡∏ô Spreadsheet ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà
            worksheet = spreadsheet.add_worksheet(title=WORKSHEET_NAME, rows="100", cols="20")
            print(f"‡∏™‡∏£‡πâ‡∏≤‡∏á Worksheet ‡πÉ‡∏´‡∏°‡πà‡∏ä‡∏∑‡πà‡∏≠ '{WORKSHEET_NAME}'")
        
        # ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô DataFrame ‡∏•‡∏á Sheets
        set_with_dataframe(worksheet, final_df, row=1, col=1, include_index=False, resize=True)
        
        print(f"*** ‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• {len(final_df)} ‡πÅ‡∏ñ‡∏ß‡πÑ‡∏õ‡∏¢‡∏±‡∏á ID: {GOOGLE_SHEET_ID} ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô ***")
        print(f"‡∏•‡∏¥‡∏á‡∏Å‡πå Spreadsheet: {spreadsheet.url}")
        
    except FileNotFoundError:
        print(f"!!! ERROR: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå {CREDENTIALS_FILE} ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏û‡∏≤‡∏ò !!!")
    except Exception as e:
        print(f"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠/‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà Google Sheets: {e}")
        print("‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÑ‡∏î‡πâ‡πÅ‡∏ä‡∏£‡πå Spreadsheet ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏• Service Account ‡πÅ‡∏•‡πâ‡∏ß")


if __name__ == '__main__':
    run_publication_pipeline()